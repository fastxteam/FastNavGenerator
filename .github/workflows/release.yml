name: Create Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pywin32

      - name: Build executables
        run: |
          REM Build main program
          echo "Building FastNavGenerator.exe..."
          pyinstaller --onefile --noconsole FastNavGenerator.py
          
          REM Build service program
          echo "Building FastNavService.exe..."
          pyinstaller --onefile --noconsole --hidden-import=win32timezone FastNavService.py
          
          echo "Build completed!"
        shell: cmd

      - name: Prepare Release Package
        run: |
          REM Create release directory
          mkdir staging
          
          REM Copy executables
          copy dist\FastNavGenerator.exe staging\
          copy dist\FastNavService.exe staging\
          
          REM Copy batch and source files
          copy FastNavGenerator.bat staging\
          
          REM Copy config file if exists
          if exist FastNavGenerator.json copy FastNavGenerator.json staging\
          
          REM Create simple default config if not exists
          if not exist staging\FastNavGenerator.json (
              echo { > staging\FastNavGenerator.json
              echo   "site": { >> staging\FastNavGenerator.json
              echo     "title": "FastNav Center", >> staging\FastNavGenerator.json
              echo     "default_layout": "list" >> staging\FastNavGenerator.json
              echo   }, >> staging\FastNavGenerator.json
              echo   "categories": [ >> staging\FastNavGenerator.json
              echo     { >> staging\FastNavGenerator.json
              echo       "name": "Tools", >> staging\FastNavGenerator.json
              echo       "icon": "üõ†Ô∏è", >> staging\FastNavGenerator.json
              echo       "type": "normal" >> staging\FastNavGenerator.json
              echo     } >> staging\FastNavGenerator.json
              echo   ] >> staging\FastNavGenerator.json
              echo } >> staging\FastNavGenerator.json
          )
        shell: cmd

      - name: Create ZIP Archive
        run: |
          $version = "${{ github.ref_name }}"
          $zipName = "FastNavGenerator-$version-windows.zip"
          Compress-Archive -Path staging\* -DestinationPath $zipName
          echo "Created: $zipName"
          echo "zip_name=$zipName" >> $env:GITHUB_ENV
        shell: powershell

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: FastNavGenerator-${{ github.ref_name }}-windows.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show release info
        run: |
          echo "‚úÖ Release package created: FastNavGenerator-${{ github.ref_name }}-windows.zip"
          echo ""
          echo "üì¶ Contents:"
          echo "  ‚Ä¢ FastNavGenerator.exe     - Main program"
          echo "  ‚Ä¢ FastNavService.exe      - Windows service"
          echo "  ‚Ä¢ FastNavGenerator.bat    - Main menu interface"
          echo "  ‚Ä¢ FastNavGenerator.json   - Config file"
          echo ""
          echo "üöÄ Usage:"
          echo "  1. Extract ZIP file"
          echo "  2. Run FastNavGenerator.bat"
          echo "  3. Select from menu"
          echo ""
          echo "üåê Access: http://localhost:8080"
        shell: bash