name: Create Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build executable
        run: |
          echo "Building FastNavGenerator.exe..."
          pyinstaller --onefile --noconsole FastNavGenerator.py
          echo "Build completed!"
        shell: cmd

      - name: Prepare Release Package
        run: |
          REM Create release directory
          mkdir staging
          
          REM Copy essential files
          copy dist\FastNavGenerator.exe staging\
          copy FastNavGenerator.bat staging\
          
          REM Copy config file if exists
          if exist FastNavGenerator.json copy FastNavGenerator.json staging\
          
          REM Create minimal config if not exists
          if not exist staging\FastNavGenerator.json (
              echo { > staging\FastNavGenerator.json
              echo   "site": { >> staging\FastNavGenerator.json
              echo     "title": "FastNav Center", >> staging\FastNavGenerator.json
              echo     "default_layout": "list", >> staging\FastNavGenerator.json
              echo     "port": 8002 >> staging\FastNavGenerator.json
              echo   } >> staging\FastNavGenerator.json
              echo } >> staging\FastNavGenerator.json
          )
          
          REM Copy nssm directory if exists
          if exist nssm (
              xcopy /E /I nssm staging\nssm
          ) else (
              REM Create nssm directory structure
              mkdir staging\nssm
              mkdir staging\nssm\win32
              mkdir staging\nssm\win64
              echo Download NSSM from: https://nssm.cc/download > staging\nssm\README.txt
              echo Place nssm.exe in win64 folder for 64-bit Windows > staging\nssm\README.txt
          )
          
          REM Copy webhttp directory if exists
          if exist webhttp (
              xcopy /E /I webhttp staging\webhttp
          ) else (
              REM Create webhttp directory structure
              mkdir staging\webhttp
              echo Place HTTP server executables here > staging\webhttp\README.txt
              echo Options: nhttp.exe or simple-http-server.exe > staging\webhttp\README.txt
          )
        shell: cmd

      - name: Create ZIP Archive
        run: |
          $version = "${{ github.ref_name }}"
          $zipName = "FastNavGenerator-$version-windows-portable.zip"
          Compress-Archive -Path staging\* -DestinationPath $zipName
          echo "zip_name=$zipName" >> $env:GITHUB_ENV
          echo "Created: $zipName"
        shell: powershell

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: FastNavGenerator-${{ github.ref_name }}-windows.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show release info
        run: |
          echo "âœ… Release package created: FastNavGenerator-${{ github.ref_name }}-windows.zip"
          echo ""
          echo "ðŸ“¦ Minimal Package Contents:"
          echo "FastNavGenerator/"
          echo " â”œâ”€â”€ nssm/"
          echo " â”‚   â”œâ”€â”€ win32/"
          echo " â”‚   â”‚   â””â”€â”€ nssm.exe"
          echo " â”‚   â””â”€â”€ win64/"
          echo " â”‚       â””â”€â”€ nssm.exe"
          echo " â”œâ”€â”€ webhttp/"
          echo " â”‚   â”œâ”€â”€ nhttp.exe"
          echo " â”‚   â””â”€â”€ simple-http-server.exe"
          echo " â”œâ”€â”€ FastNavGenerator.bat"
          echo " â”œâ”€â”€ FastNavGenerator.json"
          echo " â””â”€â”€ FastNavGenerator.exe"
          echo ""
          echo "ðŸš€ Usage:"
          echo "1. Add actual binaries to nssm and webhttp folders"
          echo "2. Run FastNavGenerator.bat"
          echo "3. Access: http://localhost:8002"
        shell: bash